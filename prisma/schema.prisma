generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                   String    @id @default(uuid())
  email                String    @unique
  googleId             String    @unique
  sensayUserId         String?
  password             String?
  isVerified           Boolean   @default(false)
  firstName            String?
  lastName             String?
  lastLogin            DateTime?
  role                 String    @default("caretaker")
  verificationToken    String?
  otpCode              String?
  otpExpires           DateTime?
  passwordResetToken   String?
  passwordResetExpires DateTime?
  albums               Json?
  photos               Json?
  replicaImageUrl      String?
  replicaImageId       String?
  replicas             Json?
  deletedReplicas      Json?
  whitelistedPatients  String[]  @default([])
  patientWhitelist     Json?
  gallery              Json?
  createdAt            DateTime  @default(now())
  updatedAt            DateTime  @updatedAt

  caretakerPatients    Patient[]       @relation("CaretakerPatients")
  linkedPatientRecords Patient[]       @relation("PatientUser")
  conversations        Conversation[]
}

model Patient {
  id              String    @id @default(uuid())
  email           String
  caretakerId     String
  caretakerEmail  String?
  userId          String?
  firstName       String?
  lastName        String?
  allowedReplicas String[]  @default([])
  isActive        Boolean   @default(true)
  lastLogin       DateTime?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  caretaker       User      @relation("CaretakerPatients", fields: [caretakerId], references: [id])
  linkedUser      User?     @relation("PatientUser", fields: [userId], references: [id])

  @@unique([email, caretakerId])
  @@index([email])
}

model Conversation {
  id            String   @id @default(uuid())
  userId        String
  replicaId     String
  title         String?
  messages      Json?
  isActive      Boolean  @default(true)
  lastMessageAt DateTime?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  user          User     @relation(fields: [userId], references: [id])

  @@index([userId, replicaId, lastMessageAt])
}
